<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard de Denúncias</title>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { background-color: #f8f9fa; color: #343a40; }
    .card { border-radius: 15px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
    h2 { margin-bottom: 30px; }
    canvas { max-height: 300px; }
    .navbar .btn { margin-left: auto; }
    .card-header { font-weight: bold; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark" style="background-color:#8B0000;">
  <div class="container">
    <a class="navbar-brand" href="#">Dashboard</a>
    <a class="btn btn-light" href="/">Nova denúncia</a>
  </div>
</nav>

<!-- Conteúdo -->
<div class="container my-5">
    <h2>Estatísticas de Denúncias</h2>
    <div class="row">
        <!-- Gráfico por categoria -->
        <div class="col-lg-6 mb-4">
            <div class="card p-3">
                <h5>Total de denúncias por categoria</h5>
                <canvas id="categoriaChart"></canvas>
            </div>
        </div>
        <!-- Gráfico por mês -->
        <div class="col-lg-6 mb-4">
            <div class="card p-3">
                <h5>Total de denúncias por mês</h5>
                <canvas id="mesChart"></canvas>
            </div>
        </div>
        <!-- Total geral -->
        <div class="col-12 mb-4">
            <div class="card p-3 text-center">
                <h5>Total Geral de denúncias: <span id="totalGeral">0</span></h5>
            </div>
        </div>
    </div>

    <!-- Denúncias detalhadas -->
    <div class="row my-4">
        <div class="col-12">
            <h3>Denúncias Detalhadas por Categoria</h3>
            <div id="dashboardContent" class="row"></div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="bg-dark text-white py-3">
    <div class="container text-center">
        &copy; 2025 Anselmo D.Bisiro & Alvaro A.Chidala. Todos os direitos reservados.
    </div>
</footer>

<!-- JS Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- JS do dashboard -->
<script>
async function carregarEstatisticas() {
    try {
        const res = await fetch('/api/stats');
        const data = await res.json();

        document.getElementById('totalGeral').textContent = data.total_geral;

        // Gráfico categorias
        const ctxCategoria = document.getElementById('categoriaChart').getContext('2d');
        new Chart(ctxCategoria, {
            type: 'pie',
            data: {
                labels: Object.keys(data.total_categorias),
                datasets: [{
                    data: Object.values(data.total_categorias),
                    backgroundColor: ['#8B0000','#6c757d','#dc3545','#B22222','#a9a9a9']
                }]
            },
            options: { responsive: true }
        });

        // Gráfico meses
        const ctxMes = document.getElementById('mesChart').getContext('2d');
        new Chart(ctxMes, {
            type: 'bar',
            data: {
                labels: Object.keys(data.total_meses),
                datasets: [{
                    label: 'Denúncias por mês',
                    data: Object.values(data.total_meses),
                    backgroundColor: '#8B0000'
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true, precision:0 } }
            }
        });

    } catch (err) {
        console.error('Erro ao carregar estatísticas:', err);
        alert('Erro ao carregar estatísticas do dashboard.');
    }
}

async function carregarDenuncias() {
    try {
        const res = await fetch('/api/denuncias');
        const data = await res.json();
        const container = document.getElementById('dashboardContent');
        container.innerHTML = '';

        for (const categoria in data) {
            const denuncias = data[categoria];
            const card = document.createElement('div');
            card.className = 'col-lg-6 mb-4';
            card.innerHTML = `
                <div class="card">
                    <div class="card-header" style="background-color:#8B0000; color:white;">${categoria} (${denuncias.length})</div>
                    <div class="card-body">
                        ${denuncias.map(d => `<p><small>${d.data_criacao}</small><br>${d.descricao}</p>`).join('')}
                    </div>
                </div>
            `;
            container.appendChild(card);
        }

    } catch (err) {
        console.error('Erro ao carregar denúncias:', err);
        alert('Não foi possível carregar as denúncias detalhadas.');
    }
}

// Chamar funções
carregarEstatisticas();
carregarDenuncias();
</script>

</body>
</html>
